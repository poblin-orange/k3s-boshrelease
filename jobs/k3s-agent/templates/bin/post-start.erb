#!/bin/bash

#uncordon if agent drain set
<% if_p('k3s.drain.kubeconfig') do |kubeconfig| %>
#create local kubeconfig
cat - > /var/vcap/data/k3s-agent/drain-kubeconfig.yaml <<EOF
<%= kubeconfig %>
EOF

#uncordon
/var/vcap/packages/kubectl-k3s/kubectl --kubeconfig=/var/vcap/data/k3s-agent/drain-kubeconfig.yaml uncordon <%= spec.name %>-<%= spec.index %> \
>> $JOB_DIR/post-start.log \
2>> $JOB_DIR/post-start-stderr.log


<% end %>

#tempo to wait for kubelet to schedule pods before finishing instance group update
sleep <%= p('k3s.bosh-post-start-delay-seconds') %>

echo 0; exit 0
